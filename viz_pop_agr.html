<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Cropland vs Population</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.js"></script>
    <link href='MapboxHousePrice_example_styles.css' rel='stylesheet' />  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
        #panel{
            position:absolute;
            bottom:16px;
            left:16px;
            width:400px;
            max-width: 40vw;
            background: rgba(255, 255, 255, 0.88);
            border-radius: 8px;
            padding: 8px;
            font-family: Arial, sans-serif;
            z-index: 10;
            overflow-y: auto;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            box-shadow: 0 10px 28px rgba(246, 246, 246, 0.1);
        }
      
        .panel-title{
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .chartCanvasWrap{
            height: 185px;  
        }
        
        .chartCanvasWrap canvas{
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        #infoBox{
            position: absolute;
            top: 16px;
            left: 16px;
            width: 388px;
            height: 285px;
            max-width: 40vw; 
            background: rgba(255, 255, 255, 0.90);
            border-radius: 12px;
            padding: 14px 14px;
            font-family: Arial, sans-serif;
            z-index: 20;
            box-shadow: 0 10px 28px rgba(246,246,246,0.10);
          }

        .info-title1{
            font-weight: 800;
            font-size: 22px;
            line-height: 1.1;
            margin-bottom: 6px;
            color: #70A22E;
          }

        .info-title2{
            font-weight: 800;
            font-size: 22px;
            line-height: 1.1;
            margin-bottom: 10px;
          }  

        .info-subtitle{
            opacity: 0.75;
            font-size: 15px;
            margin-bottom: 15px;
          }

        .info-meta{
            font-size: 12px;
            line-height: 1.4;
            border-left: 3px solid rgba(0,0,0,0.15);
            opacity: 0.75;
            line-height: 1.35;
            margin-bottom: 12px;
            padding-left: 12px;
          }

        .info-legend{
            margin-bottom: 10px;
          }

        .legend-row{
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 0;
            font-size: 12px;
          }

        .swatch{
            width: 12px;
            height: 8px;
            border-radius: 3px;
            display: inline-block;
          }

        .swatch-pop{ background: #000000; }  
        .swatch-crop10{ background: #6EA018; } 
        .swatch-crop20{ background: #42B21F; }
        .swatch-crop30{ background: #0B6A06; }
        .swatch-crop40{ background: #3C5828; }

        .info-small{
            font-size: 12px;
            opacity: 0.85;
          }
    </style>
</head>

<body>

<div id='map'></div>

<!-- Info box -->
<div id="infoBox">
  <div class="info-title1">CROPLAND COVER and</div>
  <div class="info-title2">POPULATION CHANGE</div>
  <div class="info-subtitle">How have cropland cover and population changed across countries over time?</div>

  <div class="info-meta">
    <div>Cropland by year per country: <a href="https://www.fao.org/faostat/en/#data/RL" target="_blank">FAOSTAT</a></div>
    <div>Population by year per country: <a href="https://data.worldbank.org/indicator/SP.POP.TOTL" target="_blank">World Bank - Population</a></div>
    <div>Countries official boundaries: <a href=" https://datacatalog.worldbank.org/search/dataset/0038272/world-bank-official-boundaries" target="_blank">World Bank - Boundaries</a></div>
    <div>World Cropland cover and urba areas: Copernicus satellite</div>
  </div>

  <div class="info-legend">
    <div class="legend-row">
      <span class="swatch swatch-pop"></span>
      <span>Urban area</span>
    </div>
    <div class="legend-row">
      <span class="swatch swatch-crop10"></span>
      <span>Sparse cropland</span>
    </div>
        <div class="legend-row">
      <span class="swatch swatch-crop20"></span>
      <span>Mosaic cropland</span>
    </div>
        <div class="legend-row">
      <span class="swatch swatch-crop30"></span>
      <span>Medium coverage</span>
    </div>
        <div class="legend-row">
      <span class="swatch swatch-crop40"></span>
      <span>High coverage</span>
    </div>
  </div>
</div>

<!-- Charts -->
<div id="panel">   
  <div class="panel-title" id="panelTitle">Select a country</div>

  <div id="chartsContainer">
  
    <!-- Population chart -->
    <div class="chartCanvasWrap">
      <canvas id="popChart"></canvas>
    </div>
    
    <!-- Cropland percentage chart -->
    <div class="chartCanvasWrap">
      <canvas id="cropChart"></canvas>
    </div>
  </div>
</div>

<script>  

// Datasets
const POP_CSV_URL  = "https://raw.githubusercontent.com/Tbtaaa/viz_pop_agr/main/viz_pop_agr/data/world_pop.csv";
const CROP_CSV_URL = "https://raw.githubusercontent.com/Tbtaaa/viz_pop_agr/main/viz_pop_agr/data/world_agr.csv";

// Define variables
let popByISO = new Map();
let cropByISO = new Map();

// Function to read detasets
function loadCSV(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: (results) => resolve(results.data),
      error: (err) => reject(err)
    });
  });
}

// Creates a series for all the countries
function buildSeriesMap(rows, isoCol, yearCol, valueCol) {
  const m = new Map();

  for (const r of rows) {
    const iso = r[isoCol];
    const year = Number(r[yearCol]);
    const val  = Number(r[valueCol]);

    if (!iso || Number.isNaN(year) || Number.isNaN(val)) continue;
    if (!m.has(iso)) m.set(iso, []);
    m.get(iso).push({ x: year, y: val });
  }

  // organize by year
  for (const [iso, arr] of m.entries()) {
    arr.sort((a, b) => a.x - b.x);
  }

  return m;
}

// Load the datasets
async function loadAllData() {
  const [popRows, cropRows] = await Promise.all([
    loadCSV(POP_CSV_URL),
    loadCSV(CROP_CSV_URL)
  ]);

  popByISO  = buildSeriesMap(popRows,  "Country_Code", "year", "Pop_value");
  cropByISO = buildSeriesMap(cropRows, "Country_Code", "year", "Crop_per");
}

let popChart, cropChart;
const Y_AXIS_WIDTH = 52;

// Animations -------------------------------------------------------------------------------------------
function makeProgressiveOptions(yTitle, yTickFormatter = null) {
  return {
    responsive: true,
    maintainAspectRatio: false,
    animation: {
      duration: 900,
      easing: "linear"
    },
    plugins: {
      legend: { display: false }
    },
    scales: {
      x: {
        type: "linear",
        min: 1990,
        max: 2025,
        title: { display: true, text: "Year" },
        ticks: { maxTicksLimit: 6,
        callback: (value) => String(value).replaceAll(",", "") }},
      y: {
        title: { display: true, 
          text: yTitle, 
          padding: {
            top: 0,
            bottom: 2
          }},
        ticks: yTickFormatter ? { callback: yTickFormatter } : {},
        afterFit: (scale) => {
        scale.width = Y_AXIS_WIDTH;
        }
      }
    }  
  };
}

// Define charts -------------------------------------------------------------------------------------
function createCharts() {
  const popCtx  = document.getElementById("popChart").getContext("2d");
  const cropCtx = document.getElementById("cropChart").getContext("2d");
  const popFmt = new Intl.NumberFormat("en", {
  notation: "compact",
  compactDisplay: "short",
  maximumFractionDigits: 1
  });

// Population chart
  popChart = new Chart(popCtx, {
    type: "line",
    data: {
      datasets: [{
        label: "Population",
        data: [],
        borderColor: "black",
        backgroundColor: "rgba(0, 0, 0, 0.05)",
        fill: true,
        pointRadius: 0,
        tension: 0.25
      }],
      },
    options: makeProgressiveOptions("People", (v) => popFmt.format(v))
  });

// Cropland chart
  cropChart = new Chart(cropCtx, {
    type: "line",
    data: {
      datasets: [{
        label: "% Cropland",
        data: [],
        borderColor: "#70A22E",
        backgroundColor: "rgba(112, 162, 46, 0.1)",
        fill: true,
        pointRadius: 0,
        tension: 0.25
      }]
    },
    options: makeProgressiveOptions("% Cropland")
  });
}

// This is the mapbox base
mapboxgl.accessToken = 'pk.eyJ1IjoidGJ0YWFhIiwiYSI6ImNta2xoNnYzejA0ZG4zZnBoOXFsbjJnY3kifQ.uYS3fcXXVnpjRIhd4GSWOA';

// Load a new map in the 'map' HTML div
var map = new mapboxgl.Map({
container: 'map', // container id
style: 'mapbox://styles/tbtaaa/cml1h8rbt001t01sg0gp4fuy6', // location of the stylesheet with the house price data layers included
center: [-75, -8], // starting position [lng, lat]
zoom: 4.1, // starting zoom
minZoom: 0, 
maxZoom: 6,
projection: 'equirectangular'
});

map.addControl(new mapboxgl.NavigationControl());
map.addControl(new mapboxgl.ScaleControl(), 'bottom-right');

// disable map rotation using right click + drag
map.dragRotate.disable();

// disable map rotation using touch rotation gesture
map.touchZoomRotate.disableRotation();

map.on('load', async () => {
  await loadAllData();
  createCharts();

  map.addSource("countries-src", {
    type: "vector",
    url: "mapbox://tbtaaa.0iwy57p6",
    maxzoom: 5
    });

// This must match the source-layer name INSIDE the tileset
const SOURCE_LAYER = "world_boundaries_simp02-210taa";

// This must match the attribute name in your tileset properties
const NAME_FIELD = "Cntry_C";
const COUNTRY_FIELD = "Cntry_N";

// Country
map.addLayer({  
    id: 'Countries',
    type: 'fill',
    source:  "countries-src",
    "source-layer": SOURCE_LAYER,
    paint: {
        'fill-color': '#fff',
        'fill-opacity': 0
    }
});

// Highlight
map.addLayer({ 
    id: 'lahighlight',
    type: 'line',
    source: "countries-src",
    "source-layer": SOURCE_LAYER,
    paint: {
        'line-color': '#27187E',
        'line-width': 2
    },
    filter: ["==", ["get", NAME_FIELD], ""]
});

const panelEl = document.getElementById("panel");
let lastISO = null;

// What happens when mouse is on
map.on("mousemove", "Countries", (e) => {

  map.getCanvas().style.cursor = "pointer";

  panelEl.style.opacity = 1;

  if (!e.features || !e.features.length) return;

  const iso = e.features[0].properties?.[NAME_FIELD];
  const countryName = e.features[0].properties?.[COUNTRY_FIELD];

  if (!iso) return;
  if (iso === lastISO) return;
  lastISO = iso;

  document.getElementById("panelTitle").textContent = countryName;

  const popSeries  = popByISO.get(iso)  || [];
  const cropSeries = cropByISO.get(iso) || [];

  popChart.data.datasets[0].data  = popSeries;
  cropChart.data.datasets[0].data = cropSeries;

  popChart.update();
  cropChart.update();
  
  map.setFilter("lahighlight", ["==", ["get", NAME_FIELD], iso]);
});

// What happens when clicking on a country
map.on("click", "Countries", (e) => {
  if (!e.features || !e.features.length) return;

  // From zoom 2
  if (map.getZoom() < 2) return;

  const feature = e.features[0];

  // Cenre
  const bbox = turf.bbox(feature); // [minX, minY, maxX, maxY]
  const center = [(bbox[0] + bbox[2]) / 2, (bbox[1] + bbox[3]) / 2];

  // Keep zoom
  map.easeTo({
    center,
    zoom: map.getZoom(),
    offset: [180, 0],
    duration: 700
  });
});

// What happens when mouse is off
map.on("mouseleave", "Countries", () => {
    map.getCanvas().style.cursor = "";
    panelEl.style.opacity = 0;
    lastISO = null;
    map.setFilter("lahighlight", ["==", ["get", NAME_FIELD], ""]);
});

});

</script>

</body>
</html>
