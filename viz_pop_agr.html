<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Cropland vs Population</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.js"></script>
    <link href='MapboxHousePrice_example_styles.css' rel='stylesheet' />  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link href='viz_pop_agr_style.css' rel='stylesheet' />
    <!-- <link href='https://raw.githubusercontent.com/Tbtaaa/viz_pop_agr/viz_pop_agr_style.css' rel='stylesheet' /> -->

</head>

<body>

<div id='map'></div>

<!-- Info box -->
<div id="infoBox">
  <div class="info-title1">CROPLAND COVER and</div>
  <div class="info-title2">POPULATION CHANGE</div>
  <div class="info-subtitle">How have cropland cover and population changed across countries over time?</div>

  <div class="info-meta">
    <div>Cropland by year per country: <a href="https://www.fao.org/faostat/en/#data/RL" target="_blank">FAOSTAT</a></div>
    <div>Population by year per country: <a href="https://data.worldbank.org/indicator/SP.POP.TOTL" target="_blank">World Bank - Population</a></div>
    <div>Countries official boundaries: <a href=" https://datacatalog.worldbank.org/search/dataset/0038272/world-bank-official-boundaries" target="_blank">World Bank - Boundaries</a></div>
    <div>World Cropland cover and urba areas: Copernicus satellite</div>
  </div>

  <div class="info-legend">
    <div class="legend-row">
      <span class="swatch swatch-pop"></span>
      <span>Urban area</span>
    </div>
    <div class="legend-row">
      <span class="swatch swatch-crop10"></span>
      <span>Sparse cropland</span>
    </div>
        <div class="legend-row">
      <span class="swatch swatch-crop20"></span>
      <span>Mosaic cropland</span>
    </div>
        <div class="legend-row">
      <span class="swatch swatch-crop30"></span>
      <span>Medium coverage</span>
    </div>
        <div class="legend-row">
      <span class="swatch swatch-crop40"></span>
      <span>High coverage</span>
    </div>
  </div>
</div>

<!-- Charts -->
<div id="panel">   
   <button id="closePanel" aria-label="Close panel">×</button>
  <div class="panel-title" id="panelTitle">Select a country</div>

  <div id="chartsContainer">
  
    <!-- Population chart -->
    <div class="chartCanvasWrap">
      <canvas id="popChart"></canvas>
    </div>
    
    <!-- Cropland percentage chart -->
    <div class="chartCanvasWrap">
      <canvas id="cropChart"></canvas>
    </div>
  </div>
</div>

<script>  

// Datasets
const POP_CSV_URL  = "https://raw.githubusercontent.com/Tbtaaa/viz_pop_agr/main/viz_pop_agr/data/world_pop.csv";
const CROP_CSV_URL = "https://raw.githubusercontent.com/Tbtaaa/viz_pop_agr/main/viz_pop_agr/data/world_agr.csv";

// Define variables
let popByISO = new Map();
let cropByISO = new Map();

// Function to read detasets
function loadCSV(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: (results) => resolve(results.data),
      error: (err) => reject(err)
    });
  });
}

// Creates a series for all the countries
function buildSeriesMap(rows, isoCol, yearCol, valueCol) {
  const m = new Map();

  for (const r of rows) {
    const iso = r[isoCol];
    const year = Number(r[yearCol]);
    const val  = Number(r[valueCol]);

    if (!iso || Number.isNaN(year) || Number.isNaN(val)) continue;
    if (!m.has(iso)) m.set(iso, []);
    m.get(iso).push({ x: year, y: val });
  }

  // organize by year
  for (const [iso, arr] of m.entries()) {
    arr.sort((a, b) => a.x - b.x);
  }

  return m;
}

// Load the datasets
async function loadAllData() {
  const [popRows, cropRows] = await Promise.all([
    loadCSV(POP_CSV_URL),
    loadCSV(CROP_CSV_URL)
  ]);

  popByISO  = buildSeriesMap(popRows,  "Country_Code", "year", "Pop_value");
  cropByISO = buildSeriesMap(cropRows, "Country_Code", "year", "Crop_per");
}

let popChart, cropChart;
const Y_AXIS_WIDTH = 52;

// Reveal (clip) from left plugin for Chart.js
const revealFromLeftPlugin = {
  id: "revealFromLeft",
  beforeDatasetsDraw(chart) {
    const { ctx, chartArea } = chart;
    if (!chartArea) return;

    const t = chart.$revealT ?? 1; // 0..1
    const w = chartArea.width * t;

    ctx.save();
    ctx.beginPath();
    ctx.rect(chartArea.left, chartArea.top, w, chartArea.height);
    ctx.clip();
  },
  afterDatasetsDraw(chart) {
    chart.ctx.restore();
  }
};

Chart.register(revealFromLeftPlugin);

// Manual reveal animation (no morph between countries)
function revealChartFromLeft(chart, duration = 1200) {
  chart.$revealT = 0;
  const start = performance.now();

  function frame(now) {
    chart.$revealT = Math.min(1, (now - start) / duration);
    chart.draw();
    if (chart.$revealT < 1) requestAnimationFrame(frame);
  }

  requestAnimationFrame(frame);
}

// Animations -------------------------------------------------------------------------------------------
function makeProgressiveOptions(yTitle, yTickFormatter = null) {
  return {
    interaction: {
      mode: "index",
      intersect: false
    },
    plugins: {
      legend: { display: false },
      revealFromLeft: {},
      tooltip: {
  enabled: true,
  mode: "index",
  intersect: false,
  displayColors: false,
  position: "nearest",

  // ✅ cuadro
  backgroundColor: (ctx) => {
    const label = ctx?.tooltip?.dataPoints?.[0]?.dataset?.label || "";
    // Population -> negro, Cropland -> verde
    return label.includes("Cropland") ? "#70A22E" : "#000000";
  },
  borderWidth: 0,
  cornerRadius: 8,
  padding: {
  top: 6,
  bottom: 6,
  left: 8,
  right: 8
},
  caretSize: 6,

  // ✅ texto blanco
  titleColor: "#ffffff",
  bodyColor: "#ffffff",

  titleFont: { weight: "700", size: 12, lineHeight: 0.8 }, // año bold
  bodyFont: { weight: "400", size: 12, lineHeight: 0.8 },  // valor regular

  callbacks: {
    // ✅ Año arriba
    title: (items) => {
      const year = items?.[0]?.parsed?.x;
      return year != null ? String(year) : "";
    },
    // ✅ Valor abajo (solo número)
    label: (ctx) => {
      const v = ctx.parsed.y;
      return v != null ? Number(v).toLocaleString() : "";
    }
  }
}
    },
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    scales: {
      x: {
        type: "linear",
        min: 1990,
        max: 2025,
        title: { display: true, text: "Year" },
        ticks: {
          maxTicksLimit: 6,
          callback: (value) => String(value).replaceAll(",", "")
        }
      },
      y: {
        title: {
          display: true,
          text: yTitle,
          padding: { top: 0, bottom: 2 }
        },
        ticks: yTickFormatter ? { callback: yTickFormatter } : {},
        afterFit: (scale) => {
          scale.width = Y_AXIS_WIDTH;
        }
      }
    }
  };
}

// Define charts -------------------------------------------------------------------------------------
function createCharts() {
  const popCtx  = document.getElementById("popChart").getContext("2d");
  const cropCtx = document.getElementById("cropChart").getContext("2d");
  const popFmt = new Intl.NumberFormat("en", {
  notation: "compact",
  compactDisplay: "short",
  maximumFractionDigits: 1
  });

// Population chart
  popChart = new Chart(popCtx, {
    type: "line",
    data: {
      datasets: [{
        label: "Population",
        data: [],
        borderColor: "black",
        backgroundColor: "rgba(0, 0, 0, 0.05)",
        fill: true,
        pointRadius: 0,
        tension: 0.25
      }],
      },
    options: makeProgressiveOptions("People", (v) => popFmt.format(v))
  });

// Cropland chart
  cropChart = new Chart(cropCtx, {
    type: "line",
    data: {
      datasets: [{
        label: "% Cropland",
        data: [],
        borderColor: "#70A22E",
        backgroundColor: "rgba(112, 162, 46, 0.1)",
        fill: true,
        pointRadius: 0,
        tension: 0.25
      }]
    },
    options:{
      ...makeProgressiveOptions("% Cropland"),
      scales: {
        ...makeProgressiveOptions("% Cropland").scales,
      y: {
        ...makeProgressiveOptions("% Cropland").scales.y,
      min: 0,
      max: 70
    }
  }
}
  });
}

// This is the mapbox base
mapboxgl.accessToken = 'pk.eyJ1IjoidGJ0YWFhIiwiYSI6ImNta2xoNnYzejA0ZG4zZnBoOXFsbjJnY3kifQ.uYS3fcXXVnpjRIhd4GSWOA';

// Load a new map in the 'map' HTML div
var map = new mapboxgl.Map({
container: 'map', // container id
style: 'mapbox://styles/tbtaaa/cml1h8rbt001t01sg0gp4fuy6', // location of the stylesheet with the house price data layers included
center: [-75, -8], // starting position [lng, lat]
zoom: 4.1, // starting zoom
minZoom: 2, 
maxZoom: 6,
projection: 'equirectangular'
});

map.addControl(new mapboxgl.NavigationControl());
map.addControl(new mapboxgl.ScaleControl(), 'bottom-right');

// disable map rotation using right click + drag
map.dragRotate.disable();

// disable map rotation using touch rotation gesture
map.touchZoomRotate.disableRotation();

map.on('load', async () => {
  await loadAllData();
  createCharts();

  map.addSource("countries-src", {
    type: "vector",
    url: "mapbox://tbtaaa.0iwy57p6",
    maxzoom: 5
    });

// This must match the source-layer name INSIDE the tileset
const SOURCE_LAYER = "world_boundaries_simp02-210taa";

// This must match the attribute name in your tileset properties
const NAME_FIELD = "Cntry_C";
const COUNTRY_FIELD = "Cntry_N";

// Country
map.addLayer({  
    id: 'Countries',
    type: 'fill',
    source:  "countries-src",
    "source-layer": SOURCE_LAYER,
    paint: {
        'fill-color': '#fff',
        'fill-opacity': 0
    }
});

// Highlight
map.addLayer({ 
    id: 'lahighlight',
    type: 'line',
    source: "countries-src",
    "source-layer": SOURCE_LAYER,
    paint: {
        'line-color': '#27187E',
        'line-width': 2
    },
    filter: ["==", ["get", NAME_FIELD], ""]
});

const panelEl = document.getElementById("panel");
let lastISO = null;
let pinnedISO = null;

document.getElementById("closePanel").addEventListener("click", (ev) => {
  ev.stopPropagation(); // por si acaso
  unpinCharts();
});

function showCountryCharts(iso, countryName) {
  panelEl.style.opacity = 1;
  document.getElementById("panelTitle").textContent = countryName || iso;

  const popSeries  = popByISO.get(iso)  || [];
  const cropSeries = cropByISO.get(iso) || [];

  popChart.data.datasets[0].data  = popSeries;
  cropChart.data.datasets[0].data = cropSeries;

  popChart.update("none");
  cropChart.update("none");

  revealChartFromLeft(popChart);
  revealChartFromLeft(cropChart);

  map.setFilter("lahighlight", ["==", ["get", NAME_FIELD], iso]);
  setPinnedTooltips(true);

  document.getElementById("closePanel").style.display = "block";
}

function unpinCharts() {
  pinnedISO = null;
  lastISO = null;
  panelEl.style.opacity = 0;
  panelEl.style.pointerEvents = "none";
  document.getElementById("panelTitle").textContent = "Select a country";
  map.setFilter("lahighlight", ["==", ["get", NAME_FIELD], ""]);
  setPinnedTooltips(false);
  document.getElementById("closePanel").style.display = "none";
}

function setPinnedTooltips(isPinned) {
  const on = !!isPinned;

  popChart.options.plugins.tooltip.enabled = on;
  cropChart.options.plugins.tooltip.enabled = on;

  // actualiza sin animación
  popChart.update("none");
  cropChart.update("none");
}

// What happens when mouse is on
map.on("mousemove", "Countries", (e) => {

  map.getCanvas().style.cursor = "pointer";

  panelEl.style.opacity = 1;
  panelEl.style.pointerEvents = "auto";
  if (pinnedISO) return;

  if (!e.features || !e.features.length) return;

  const iso = e.features[0].properties?.[NAME_FIELD];
  const countryName = e.features[0].properties?.[COUNTRY_FIELD];

  if (!iso) return;
  if (iso === lastISO) return;
  lastISO = iso;

  document.getElementById("panelTitle").textContent = countryName;

  const popSeries  = popByISO.get(iso)  || [];
  const cropSeries = cropByISO.get(iso) || [];

  popChart.data.datasets[0].data  = popSeries;
  cropChart.data.datasets[0].data = cropSeries;

  // update WITHOUT morphing from previous country
  popChart.update("none");
  cropChart.update("none");

  // reveal from left
  revealChartFromLeft(popChart);
  revealChartFromLeft(cropChart);  
  
  map.setFilter("lahighlight", ["==", ["get", NAME_FIELD], iso]);
});

// What happens when clicking on a country
map.on("click", "Countries", (e) => {
  if (!e.features || !e.features.length) return;
  if (map.getZoom() < 2) return;

  const iso = e.features[0].properties?.[NAME_FIELD];
  const countryName = e.features[0].properties?.[COUNTRY_FIELD];
  if (!iso) return;

  // toggle: click same country -> unpin
  if (pinnedISO === iso) {
    unpinCharts();
    return;
  }

  // pin new country
  pinnedISO = iso;
  lastISO = iso;
  showCountryCharts(iso, countryName);

  // (tu zoom-centre se queda igual)
  const feature = e.features[0];
  const bbox = turf.bbox(feature);
  const center = [(bbox[0] + bbox[2]) / 2, (bbox[1] + bbox[3]) / 2];

  map.easeTo({
    center,
    zoom: map.getZoom(),
    offset: [180, 0],
    duration: 700
  });
});

// What happens when mouse is off
map.on("mouseleave", "Countries", () => {
  if (pinnedISO) return;
    map.getCanvas().style.cursor = "";
    panelEl.style.opacity = 0;
    lastISO = null;
    map.setFilter("lahighlight", ["==", ["get", NAME_FIELD], ""]);
});

});

</script>

</body>
</html>
